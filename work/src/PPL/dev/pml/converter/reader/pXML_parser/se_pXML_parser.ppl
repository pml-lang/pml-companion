// SPDX-License-Identifier: GPL-2.0-only
// Copyright (C) 2018 - 2021 Christian Neumanns, email: chris@pml-lang.dev

service pXML_parser

    java_header
        import java.util.HashMap;
        import java.util.Map;

        import org.ppl.core.collections.java.se_Java_collection_utilities;

        import dev.pp.text.annotations.NotNull;
        import dev.pp.text.reader.exception.TextReaderException;
        import dev.pp.text.token.TextToken;

        import dev.pdml.core.data.AST.attribute.ASTNodeAttribute;
        import dev.pdml.core.data.AST.attribute.ASTNodeAttributes;
        import dev.pdml.core.data.formalNode.FormalNode;
        import dev.pdml.core.data.formalNode.FormalNodes;
        import dev.pdml.core.data.formalNode.types.PDMLType;
        import dev.pdml.core.data.formalNode.types.standard.TextBlockType;
        import dev.pdml.core.data.node.name.NodeName;
        import dev.pdml.core.reader.parser.eventHandler.NodeEndEvent;
        import dev.pdml.core.reader.parser.eventHandler.NodeStartEvent;
        import dev.pdml.core.reader.parser.eventHandler.ParserEventHandler;
        import dev.pdml.core.reader.parser.EventStreamParserBuilder;
        import dev.pdml.core.reader.reader.extensions.PXMLExtensionsHandler;

        import dev.pdml.ext.extensions.DefaultPXMLExtensionsHandler;
        import dev.pdml.ext.extensions.node.PXMLExtensionHandler;
        import dev.pdml.ext.extensions.node.standard.ConstantDeclaration_ExtensionHandler;
        import dev.pdml.ext.extensions.node.standard.InsertConstant_ExtensionHandler;
        import dev.pdml.ext.extensions.node.standard.InsertFile_ExtensionHandler;

        import dev.pml.converter.data.formal_node.block.with_raw_text_content.nodes.se_PML_HTML_code_formal_node;
        import dev.pml.converter.data.formal_node.block.with_raw_text_content.nodes.se_PML_input_formal_node;
        import dev.pml.converter.data.formal_node.block.with_raw_text_content.nodes.se_PML_output_formal_node;
        import dev.pml.converter.data.formal_node.block.with_raw_text_content.nodes.se_PML_source_code_formal_node;
        import dev.pml.converter.data.formal_node.se_PML_formal_node_registry;
        import dev.pml.converter.data.formal_node.ty_PML_formal_node;
        import dev.pml.converter.PP_text_bridge.error.fa_text_error;
        import dev.pml.converter.PP_text_bridge.token.fa_text_token;
        import dev.pml.converter.PDML_bridge.data.node.attribute.fa_AST_node_attribute;
        import dev.pml.converter.PDML_bridge.data.node.attribute.fa_AST_node_attributes;
        import dev.pml.converter.PDML_bridge.data.node.attribute.ty_AST_node_attributes;
        import dev.pml.converter.PDML_bridge.data.node.fa_mutable_PDML_AST_node;
        import dev.pml.converter.PDML_bridge.data.node.name.fa_AST_node_name;
        import dev.pml.converter.PDML_bridge.data.node.name.ty_AST_node_name;
        import dev.pml.converter.PDML_bridge.data.node.ty_mutable_PDML_AST_node;
    end java_header

    java
        static class CreateTree_ParserEventHandler implements ParserEventHandler<ty_mutable_PDML_AST_node, ty_mutable_PDML_AST_node> {


            private ty_mutable_PDML_AST_node rootNode;


            public CreateTree_ParserEventHandler() {}


            public void onStart() {}

            public void onEnd () {}

            public @NotNull ty_mutable_PDML_AST_node onRootNodeStart ( @NotNull NodeStartEvent event ) {

                rootNode = createNode ( event );
                return rootNode;
            }

            public void onRootNodeEnd ( @NotNull NodeEndEvent event, @NotNull ty_mutable_PDML_AST_node node ) {}

            public @NotNull ty_mutable_PDML_AST_node onNodeStart ( @NotNull NodeStartEvent event, @NotNull ty_mutable_PDML_AST_node parent_node ) {

                ty_mutable_PDML_AST_node node = createNode ( event );
                parent_node.append_child_node ( node );
                return node;
            }

            public void onNodeEnd ( @NotNull NodeEndEvent event, @NotNull ty_mutable_PDML_AST_node node ) {}

            public void onAttributes ( @NotNull ASTNodeAttributes JavaAttributes, @NotNull ty_mutable_PDML_AST_node parent_node ) {

                ty_AST_node_attributes attributes = fa_AST_node_attributes.create();

                for ( ASTNodeAttribute JavaAttribute : JavaAttributes.getList() ) {
                    attributes.add ( fa_AST_node_attribute.createFromJava ( JavaAttribute ) );
                }

                parent_node.setAttributes ( attributes );
            }

            public void onText ( @NotNull TextToken textToken, @NotNull ty_mutable_PDML_AST_node parent_node ) {

                parent_node.append_text_child (
                    fa_text_token.createFromJava ( textToken ) );
            }

            public void onComment ( @NotNull TextToken textToken, @NotNull ty_mutable_PDML_AST_node parent_node ) {

                // ignore comments
            }

            public @NotNull ty_mutable_PDML_AST_node getResult() { return rootNode; }


            private @NotNull ty_mutable_PDML_AST_node createNode ( @NotNull NodeStartEvent event ) {

                ty_AST_node_name name = fa_AST_node_name.createFromJava ( event.getName() );

                return fa_mutable_PDML_AST_node.create_for_name ( name );
            }

        }

        private static FormalNodes createFormalNodes() {

            FormalNodes formalNodes = new FormalNodes();

            se_Java_collection_utilities.forEachElementInList ( se_PML_formal_node_registry.get_list(), PML_formal_node -> {
                formalNodes.add ( PML_formal_node.getPMDLFormalNode() );
            } );

            return formalNodes;
        }

        private static PXMLExtensionsHandler createExtensionsHandler() {

            /* disabled, because PML uses PDML's syntax

            Map<String, PXMLExtensionHandler> customizedExtensionNodeHandlers =
                new HashMap<>();

            customizedExtensionNodeHandlers.put (
                se_PML_insert_file_formal_node.getNode().standard_tag().getJavaString(),
                new InsertFile_ExtensionHandler() );

            customizedExtensionNodeHandlers.put (
                se_PML_declare_constant_formal_node.getNode().standard_tag().getJavaString(),
                new ConstantDeclaration_ExtensionHandler() );
            customizedExtensionNodeHandlers.put (
                "ins-const",
                new InsertConstant_ExtensionHandler() );

            return new DefaultPXMLExtensionsHandler ( customizedExtensionNodeHandlers );
            */

            return new DefaultPXMLExtensionsHandler();
        }
    end java

    function try_parse ( config PML_to_HTML_config ) -> mutable_PDML_AST_node or text_error

        const PML_input_file = require_input_file ( i_config )
        return try_parse_file ( file = PML_input_file, error_handler = i_config.error_handler )
    .

    functions access:private

        function try_parse_file ( file, error_handler text_error_handler ) -> mutable_PDML_AST_node or text_error

            variable pXML_root_node ty_mutable_PDML_AST_node or null = null
            variable canceling_error text_error or null = null

            java
                ParserEventHandler<ty_mutable_PDML_AST_node, ty_mutable_PDML_AST_node> eventHandler =
                    new CreateTree_ParserEventHandler();

                try {
                    new EventStreamParserBuilder<> ( eventHandler )
                        .setErrorHandler ( i_error_handler.getJavaTextErrorHandler() )
                        .setExtensionsHandler ( createExtensionsHandler() )
                        .setFormalNodes ( createFormalNodes() )
                        .parseFile ( i_file.getJavaFile() );
                } catch ( TextReaderException e ) {
                    v_canceling_error = fa_text_error.createFromJava ( e.toTextError() );
                }
                v_pXML_root_node = eventHandler.getResult();
            end java

            if canceling_error is null then
                assert pXML_root_node is not null
                return pXML_root_node
            else
                return canceling_error
            .
        .

        function require_input_file ( config PML_to_HTML_config ) -> file

            const r = i_config.PML_input_file
            if r is not null then
                return r
            else
                throw "Requiring an input file."
            .
        .
    .
.
